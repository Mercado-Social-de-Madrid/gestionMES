{% extends 'base.html' %}
{% load staticfiles %}
{% load settings_value %}
{% load l10n %}
{% load chunks %}

{% block title %}Proveedoras | {{object.display_name}} {% endblock %}

{% block bodyattrs %} id="login-page" class="main-bg" {% endblock%}

{% block content %}

 <div class="jumbotron py-4 px-2">
        <div class="container">
            <div class="row">
            <div class="col-sm-8 col-md-8">
                <h4 class="mb-0 breadcrumbs">
                    <a href="{% url 'accounts:providers_list' %}">Proveedoras</a>
                    <i class="material-icons md-18 ">arrow_forward_ios</i>
                    {{object.display_name}}
                </h4>

            </div>

        </div>
        </div>
    </div>

     <ul class="nav nav-justified nav-tabs" id="tabs-content" role="tablist">
      <li class="nav-item">
        <a aria-controls="profile" aria-selected="true" class="nav-link {%if details_tab%}active{%endif%}" data-toggle="tab" href="#data-form" id="data-tab" role="tab">Datos de entidad</a>
      </li>

     {% if perms.payments.mespermission_can_view_payments %}
      <li class="nav-item">
        <a aria-controls="payments" aria-selected="false" class="nav-link {%if payments_tab%} active{%endif%}" data-toggle="tab" href="#payments-form" id="payments-tab" role="tab">Contabilidad</a>
      </li>
        {% endif %}

     <li class="nav-item">
        <a aria-controls="balances" aria-selected="false" class="nav-link {%if balances_tab%} active{%endif%}" data-toggle="tab" href="#balances-form" id="balances-tab" role="tab">Balance social</a>
      </li>

     <li class="nav-item">
        <a aria-controls="currency" aria-selected="false" class="nav-link {%if currency_tab%} active{%endif%}" data-toggle="tab" href="#currency-form" id="currency-tab" role="tab">Etics</a>
      </li>
    </ul>

<div class="tab-content">
  <div aria-labelledby="data-tab" class="tab-pane p-4 px-5 {%if details_tab%}show active{%endif%}" id="data-form" role="tabpanel">

      <div class="row px-4">
          <div class="col-md-3">
              <div class="card">
                  <div class="card-body">
                       <div class="float-left lead p-2 mb-2 mr-2">
                      {% if object.is_active %}
                        <i class="material-icons">check</i>
                      {% else %}
                        <i class="material-icons">clear</i>
                      {% endif %}
                           </div>
                      <div class="float-left">
                          <label>Estado</label><br>
                            {{object.get_status_display}}
                      </div>

                      </div>
              </div>
          </div>
          <div class="col-md-4">
              <div class="card">
                  <div class="card-body">
              <label>Acogida</label><br>
                 {% if signup %}
                     <p class="pb-1"><a class="text-primary" href="{% url 'accounts:signup_detail' signup.pk %}"> {% include 'bpm/current_state.html' with workflow=signup.workflow %} <i class="material-icons mx-2">visibility</i></a></p>
                  {% else %}
                    <p class="pb-3"> Importada (previa a 2019)</p>
                  {% endif %}
                  </div>
              </div>
          </div>
          <div class="col-md-3">
              {% if object.is_active %}
                {% if perms.accounts.mespermission_can_create_deletions %}
                <a class="btn btn-secondary text-light mb-2" data-toggle="modal" data-target="#cancel-process">Dar de baja</a><br>
                {% endif %}
              {% endif %}
                <a class="btn btn-light disabled mb-2">Consultar historial</a><br>
          </div>
      </div>

      {% if object.is_active %}

      <form method="post" action="{% url 'accounts:provider_delete' object.pk %}">
         {% csrf_token %}
         <input type="hidden" name="redirect_to" value="{{redirect_to|default:request.path }}">
        <input type="hidden" name="process" value="{{object.pk}}">

        <div class="modal fade" id="cancel-process" tabindex="-1" role="dialog" aria-labelledby="cancel-process-label" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cancel-process-label">Baja de entidad</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
              <div class="mb-4 display-2 text-muted"> <i class="material-icons">error_outline</i></div>
               Esta acción creará un proceso de baja para la entidad actual.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Confirmar</button>
          </div>
        </div>
      </div>
    </div>

     </form>

      {% endif %}


      <form method="post" class="mt-1 p-4">
            {% csrf_token %}
            {{form.media}}
            {% include 'provider/form.html' %}
        <div class="text-center mt-3">
            <button type="submit" class="btn btn-primary btn-lg">Guardar</button>
        </div>

        </form>
    </div>

    <div aria-labelledby="balances-tab" class="tab-pane p-4 px-5 {% if payments_tab %}show active{%endif%}" id="balances-form" role="tabpanel">
       <div class="row">
           <div class="col-md-5">
               <h4 class="text-primary"><i class="material-icons mr-1">schedule</i> Histórico</h4>
                {% include 'balance/query.html' with object_list=social_balances %}
           </div>

           <div class="col-md-7">
               <h4 class="text-primary"><i class="material-icons mr-1">bookmark</i> Balance actual</h4>

           </div>
       </div>

    </div>

    {% if perms.payments.mespermission_can_view_payments %}
    <div aria-labelledby="payments-tab" class="tab-pane p-4 px-5 {% if payments_tab %}show active{%endif%}" id="payments-form" role="tabpanel">
       <h4 class="text-primary"><i class="material-icons mr-1">receipt</i> Pagos</h4>
       {% include 'common/ajax_wrapper.html' with query_template='payments/query.html' object_list=payments object_url_name='payments:payment_detail' %}
    </div>
    {% endif %}

    <div aria-labelledby="currency-tab" class="tab-pane p-4 px-5 {% if payments_tab %}show active{%endif%}" id="currency-form" role="tabpanel">
        <div class="row">
            <div class="col-md-4">
                {% include 'currency/app_user.html' with account=object %}
            </div>
        </div>
    </div>

  </div>

{% endblock %}


{% block extra_styles %}
<link rel='stylesheet' href="{% static 'css/libs/jquery.spectrum.css' %}" />
{% endblock extra_styles %}

{% block scripts %}
<script src="{% static 'js/jquery.spectrum.js' %}"></script>
{% include 'common/include_gmaps.html' %}
<script type="text/javascript">

function initMap() {
{% if object %}
    var entityPosition = new google.maps.LatLng({{ object.latitude|unlocalize }}, {{ object.longitude|unlocalize }});
{% else %}
    var entityPosition = new google.maps.LatLng({% settings_value "INITIAL_LATITUDE"|unlocalize %}, {% settings_value "INITIAL_LONGITUDE"|unlocalize %});
{% endif %}

    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 16,
        center: entityPosition,
        zoomControl: true,
        scaleControl: true,
        streetViewControl: false,
        mapTypeControl:false
    });

    $('#map').removeClass('loading-container');

    var marker = new RichMarker({
      position: entityPosition,
      map: map,
      draggable:true,
      content: '<div class="marker-wrapper"><div class="marker"><img src="' + '{%if entity.first_photo_url %}{{entity.first_photo_url}}{%else%}{% static "imgs/etics-icon.png" %}{%endif%}' + '"></div></div>'
    });

    var latInput = $('[name="latitude"]');
    var lngInput = $('[name="longitude"]');

    function updateMarker(){
        marker.setPosition( new google.maps.LatLng( latInput.val(), lngInput.val() ) );
        map.setCenter(marker.getPosition());
    }
    latInput.on('change',  updateMarker);
    lngInput.on('change',  updateMarker);

    google.maps.event.addListener(
        marker,
        'drag',
        function() {
            latInput.val( marker.position.lat() );
            lngInput.val( marker.position.lng() );
        }
    );

    var update_timeout = null;
    google.maps.event.addListener(map, 'click', function(event){
        update_timeout = setTimeout(function(){
            marker.setPosition(event.latLng);
            latInput.val( marker.position.lat() );
            lngInput.val( marker.position.lng() );
        }, 200);
    });

    google.maps.event.addListener(map, 'dblclick', function(event) {
        clearTimeout(update_timeout);
    });

  }

</script>
{% endblock scripts %}